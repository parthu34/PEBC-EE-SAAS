
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProductType {
  MOCK
  FULL
}

enum PurchaseStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

enum AttemptMode {
  MOCK
  FULL
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  locale    String?  @default("en-CA")
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())
  purchases Purchase[]
  credits   ExamCredit[]
  attempts  Attempt[]
  questions Question[] @relation("QuestionAuthor")
  resetTokens PasswordResetToken[]
}

model Product {
  id          String      @id @default(cuid())
  slug        String      @unique
  name        String
  type        ProductType
  priceCents  Int
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now())
  purchases   Purchase[]
  credits     ExamCredit[]
}

model Purchase {
  id         String         @id @default(cuid())
  user       User           @relation(fields: [userId], references: [id])
  userId     String
  product    Product        @relation(fields: [productId], references: [id])
  productId  String
  status     PurchaseStatus @default(PENDING)
  provider   String         @default("stripe")
  invoiceId  String?
  sessionId  String? // Stripe session id
  createdAt  DateTime @default(now())
  @@index([userId, productId])
}

model ExamCredit {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  product    Product  @relation(fields: [productId], references: [id])
  productId  String
  remaining  Int      @default(0)
  createdAt  DateTime @default(now())
  @@index([userId])
}

model Question {
  id         String   @id @default(cuid())
  topic      String
  stem       String
  options    Json
  answer     Int
  rationale  String
  difficulty String?

  conceptKey String
  anchorKey  String

  active     Boolean  @default(true)
  version    Int      @default(1)

  createdBy  String?
  author     User?    @relation("QuestionAuthor", fields: [createdBy], references: [id])

  createdAt  DateTime @default(now())

  formItems  ExamFormItem[]
  answers    AttemptAnswer[]

  @@unique([topic, conceptKey])
  @@index([conceptKey])
  @@index([anchorKey])
}

model ExamForm {
  id        String   @id @default(cuid())
  label     String   @unique
  size      Int
  rules     Json?
  version   Int      @default(1)
  published Boolean  @default(true)
  createdAt DateTime @default(now())
  items     ExamFormItem[]
  attempts  Attempt[]
}

model ExamFormItem {
  id         String   @id @default(cuid())
  form       ExamForm @relation(fields: [formId], references: [id])
  formId     String
  question   Question @relation(fields: [questionId], references: [id])
  questionId String
  position   Int
  @@unique([formId, questionId])
  @@index([formId, position])
}

model Attempt {
  id          String     @id @default(cuid())
  user        User       @relation(fields: [userId], references: [id])
  userId      String
  form        ExamForm   @relation(fields: [formId], references: [id])
  formId      String
  mode        AttemptMode
  startedAt   DateTime   @default(now())
  submittedAt DateTime?
  score       Int?
  timeLimitS  Int
  answers     AttemptAnswer[]
}

model AttemptAnswer {
  id           String   @id @default(cuid())
  attempt      Attempt  @relation(fields: [attemptId], references: [id])
  attemptId    String
  question     Question @relation(fields: [questionId], references: [id])
  questionId   String
  selected     Int?
  correct      Boolean?
  timeSpentSec Int      @default(0)
  flagged      Boolean  @default(false)
  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  @@index([userId])
  @@index([expiresAt])
}
